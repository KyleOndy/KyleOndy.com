pipeline:
  sftp_cache:
    restore: true
    mount: /drone/.stack

  build:
    image: fpco/stack-build:lts
    pull: true
    commands:
      - mkdir -p /drone/.stack
      - cp -a /drone/.stack /root
      - rm -rf /drone/.stack
      - make build
      - make check
      - cp -a /root/.stack /drone

  sftp_cache:
    rebuild: true
    mount: /drone/.stack

  deploy:
    rsync:
      user: root
      host: static.ondy.me
      port: 3220
      source: _build/kyleondy.com.tar.gz
      target: kyleondy.com/latest.tar.gz
      delete: false
      recursive: false
