pipeline:
  sftp_cache:
    restore: true
    pull: true
    mount: /drone/.stack

  build:
    image: fpco/stack-build:lts
    pull: true
    commands:
      - mkdir -p /drone/.stack
      - cp -a /drone/.stack /root
      - rm -rf /drone/.stack
      - make build
      - make check
      - make package
      - cp -a /root/.stack /drone

  sftp_cache:
    rebuild: true
    mount: /drone/.stack

  deploy:
    image: rsync
    pull: true
    user: root
    host: static.ondy.me
    port: 3220
    source: _build/kyleondy.com.tar.gz
    target: kyleondy.com/latest.tar.gz
    delete: false
    recursive: false
    commands:
      - curl -X POST https://registry.hub.docker.com/u/kyleondy/website/trigger/5eda02be-94f1-4c7c-bf7c-5287d890d0bd/
